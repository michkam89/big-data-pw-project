{
  "hash": "3ddfef2e7ce685e40e1ad0ce465a79e0",
  "result": {
    "markdown": "---\nwarnings: false\nexecute: \n  include: false\n  freeze: auto\n---\n\n# Wstępna obróbka danych {#sec-prepro-chapter}\n\n::: {.content-hidden unless-profile=\"local\"}\n\n\n:::\n\n\n## Konfiguracja aplikacji Spark\n\nW celu przygotowania danych do analizy zostały one wstępnie przetworzone. Pierwszym etapem wstępnego przetwarzania jest wczytanie danych do środowiska analitycznego. Dane surowe, przechowywane w koszyku `raw-data-beer-and-wine` znajowały się w mało przyjaznym dla analiz formacie `xml`. Wczytanie tego typu danych wymagało załadowania dodatkowego pakietu `jar` o nazwie `spark-xml_2.12:0.15.0` pobranego z repozytorium `maven`. \n\nW serwisie `EMR` można dodać tego typu pakiety wykorzystując specjalne polecenia typy `Sparkmagic` rozpoczynające się od znaków `%%`. W tym przypadku użyto `%%configure`:\n\n\\small\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\n%%configure -f\n{\n    \"conf\": {\n        \"spark.jars.packages\": \"com.databricks:spark-xml_2.12:0.15.0\"\n    }\n}\n```\n:::\n\n\n\\normalsize\n\n\n## Schematy danych {#sec-schemas}\n\n\nW celu zapewnienia wczytania danych o oczekiwanych typach oraz zapewnieniu że nie ma tam danych brakujących utworzono schematy danych, wykorzystywane w kroku wczytywania z plików `xml`. Poniżej przedstawiono schematy dla każdego z przetwarzanych plików oraz przykładowe wiersze.\n\n### Plik `Users`\n\n\\small\n\n::: {.cell execution_count=6}\n``` {.python .cell-code}\nusers_schema = StructType([\n    StructField('_AboutMe', StringType(), True),\n    StructField('_AccountId', IntegerType(), True),\n    StructField('_CreationDate', TimestampType(), True),\n    StructField(\"_DisplayName\", StringType(), True),\n    StructField(\"_DownVotes\", IntegerType(), True),\n    StructField(\"_Id\", IntegerType(), True),\n    StructField(\"_LastAccessDate\", TimestampType()),\n    StructField(\"_Location\", StringType(), True),\n    StructField(\"_ProfileImageUrl\", StringType(), True),\n    StructField(\"_Reputation\", IntegerType(), True),\n    StructField(\"_UpVotes\", IntegerType(), True),\n    StructField(\"_Views\", IntegerType(), True),\n    StructField(\"_WebsiteUrl\", StringType(), True)\n])\n```\n:::\n\n\n::: {.cell execution_count=7}\n\n::: {.cell-output .cell-output-stdout}\n```\n-RECORD 0------------------------------------------------------------------------\n _AboutMe         | <p>Hi, I'm not really a person.</p>\\n\\n<p>I'm a backgroun... \n _AccountId       | -1                                                           \n _CreationDate    | 2014-01-21 17:45:53.587                                      \n _DisplayName     | Community                                                    \n _DownVotes       | 478                                                          \n _Id              | -1                                                           \n _LastAccessDate  | 2014-01-21 17:45:53.587                                      \n _Location        | on the server farm                                           \n _ProfileImageUrl | null                                                         \n _Reputation      | 1                                                            \n _UpVotes         | 2                                                            \n _Views           | 5                                                            \n _WebsiteUrl      | http://meta.stackexchange.com/                               \nonly showing top 1 row\n\n```\n:::\n:::\n\n\n### Plik `Tags`\n\n\\small\n\n::: {.cell execution_count=8}\n``` {.python .cell-code}\ntags_schema = StructType([\n    StructField('_Count', IntegerType(), True),\n    StructField('_ExcerptPostId', IntegerType(), True),\n    StructField('_Id', IntegerType(), True),\n    StructField(\"_TagName\", StringType(), True),\n    StructField(\"_WikiPostId\", IntegerType(), True)\n])\n```\n:::\n\n\n::: {.cell execution_count=9}\n\n::: {.cell-output .cell-output-stdout}\n```\n+------+--------------+---+-----------+-----------+\n|_Count|_ExcerptPostId|_Id|   _TagName|_WikiPostId|\n+------+--------------+---+-----------+-----------+\n|    17|          5062|  1|       hops|       5061|\n|    85|          7872|  2|    history|       7871|\n|    69|          4880|  4|    brewing|       4879|\n|    37|          5109|  5|    serving|       5108|\n|    31|           304|  6|temperature|        303|\n+------+--------------+---+-----------+-----------+\nonly showing top 5 rows\n\n```\n:::\n:::\n\n\n\\normalsize\n### Plik `Votes`\n\n\\small\n\n::: {.cell execution_count=10}\n``` {.python .cell-code}\nvotes_schema = StructType([\n    StructField('_BountyAmount', IntegerType(), True),\n    StructField('_CreationDate', TimestampType(), True),\n    StructField('_Id', IntegerType(), True),\n    StructField(\"_PostId\", StringType(), True),\n    StructField(\"_UserId\", IntegerType(), True),\n    StructField(\"_VoteTypeId\", IntegerType(), True)\n])\n```\n:::\n\n\n::: {.cell execution_count=11}\n\n::: {.cell-output .cell-output-stdout}\n```\n+-------------+-------------------+---+-------+-------+-----------+\n|_BountyAmount|      _CreationDate|_Id|_PostId|_UserId|_VoteTypeId|\n+-------------+-------------------+---+-------+-------+-----------+\n|         null|2014-01-21 00:00:00|  1|      1|   null|          2|\n|         null|2014-01-21 00:00:00|  2|      1|   null|          2|\n|         null|2014-01-21 00:00:00|  3|      4|   null|          2|\n|         null|2014-01-21 00:00:00|  4|      1|   null|          2|\n|         null|2014-01-21 00:00:00|  5|      4|   null|          2|\n+-------------+-------------------+---+-------+-------+-----------+\nonly showing top 5 rows\n\n```\n:::\n:::\n\n\n\\normalsize\n### Plik `Posts`\n\n\\small\n\n::: {.cell execution_count=12}\n``` {.python .cell-code}\nposts_schema = StructType([\n    StructField('_AcceptedAnswerId', IntegerType(), True),\n    StructField('_AnswerCount', IntegerType(), True),\n    StructField('_Body', StringType(), True),\n    StructField(\"_ClosedDate\", TimestampType(), True),\n    StructField(\"_CommentCount\", IntegerType(), True),\n    StructField(\"_CommunityOwnedDate\", TimestampType(), True),\n    StructField(\"_ContentLicense\", StringType(), True),\n    StructField(\"_CreationDate\", TimestampType(), True),\n    StructField(\"_FavoriteCount\", IntegerType(), True),\n    StructField(\"_Id\", IntegerType(), True),\n    StructField(\"_LastActivityDate\", TimestampType(), True),\n    StructField(\"_LastEditDate\", TimestampType(), True),\n    StructField(\"_LastEditorDisplayName\", StringType(), True),\n    StructField(\"_LastEditorUserId\", IntegerType(), True),\n    StructField(\"_OwnerDisplayName\", StringType(), True),\n    StructField(\"_OwnerUserId\", IntegerType(), True),\n    StructField(\"_ParentId\", IntegerType(), True),\n    StructField(\"_PostTypeId\", IntegerType(), True),\n    StructField(\"_Score\", IntegerType(), True),\n    StructField(\"_Tags\", StringType(), True),\n    StructField(\"_Title\", StringType(), True),\n    StructField(\"_ViewCount\", IntegerType(), True),\n])\n```\n:::\n\n\n::: {.cell execution_count=13}\n\n::: {.cell-output .cell-output-stdout}\n```\n-RECORD 0------------------------------------------------------------------------------\n _AcceptedAnswerId      | 4                                                            \n _AnswerCount           | 1                                                            \n _Body                  | <p>I was offered a beer the other day that was reportedly... \n _ClosedDate            | null                                                         \n _CommentCount          | 0                                                            \n _CommunityOwnedDate    | null                                                         \n _ContentLicense        | CC BY-SA 3.0                                                 \n _CreationDate          | 2014-01-21 20:26:05.383                                      \n _FavoriteCount         | null                                                         \n _Id                    | 1                                                            \n _LastActivityDate      | 2014-01-21 22:04:34.977                                      \n _LastEditDate          | 2014-01-21 22:04:34.977                                      \n _LastEditorDisplayName | null                                                         \n _LastEditorUserId      | 8                                                            \n _OwnerDisplayName      | null                                                         \n _OwnerUserId           | 7                                                            \n _ParentId              | null                                                         \n _PostTypeId            | 1                                                            \n _Score                 | 21                                                           \n _Tags                  | <hops>                                                       \n _Title                 | What is a citra hop, and how does it differ from other hops? \n _ViewCount             | 2434                                                         \nonly showing top 1 row\n\n```\n:::\n:::\n\n\n\\normalsize\n### Plik `Post Links`\n\n\\small\n\n::: {.cell execution_count=14}\n``` {.python .cell-code}\nlinks_schema = StructType([\n    StructField(\"_CreationDate\", TimestampType()),\n    StructField(\"_Id\", IntegerType()),\n    StructField(\"_LinkTypeId\", IntegerType()),\n    StructField(\"_PostId\", IntegerType()),\n    StructField(\"_RelatedPostId\", IntegerType())\n])\n```\n:::\n\n\n::: {.cell execution_count=15}\n\n::: {.cell-output .cell-output-stdout}\n```\n+-----------------------+---+-----------+-------+--------------+\n|_CreationDate          |_Id|_LinkTypeId|_PostId|_RelatedPostId|\n+-----------------------+---+-----------+-------+--------------+\n|2014-01-21 21:04:25.23 |25 |3          |29     |25            |\n|2014-01-21 21:42:09.103|89 |1          |83     |50            |\n|2014-01-21 21:50:41.313|95 |1          |86     |2             |\n|2014-01-21 22:07:35.783|101|3          |47     |99            |\n|2014-01-21 22:13:51.38 |102|1          |74     |3             |\n+-----------------------+---+-----------+-------+--------------+\nonly showing top 5 rows\n\n```\n:::\n:::\n\n\n\\normalsize\n### Plik `Post History`\n\n\\small\n\n::: {.cell execution_count=16}\n``` {.python .cell-code}\nhistory_schema = StructType([\n    StructField(\"_Comment\", StringType()),\n    StructField(\"_ContentLicense\", StringType()),\n    StructField(\"_CreationDate\", TimestampType()),\n    StructField(\"_Id\", IntegerType()),\n    StructField(\"_PostHistoryTypeId\", IntegerType()),\n    StructField(\"_PostId\", IntegerType()),\n    StructField(\"_RevisionGUID\", StringType()),\n    StructField(\"_Text\", StringType()),\n    StructField(\"_UserDisplayName\", StringType()),\n    StructField(\"_UserId\", IntegerType()),\n])\n```\n:::\n\n\n::: {.cell execution_count=17}\n\n::: {.cell-output .cell-output-stdout}\n```\n-RECORD 0--------------------------------------------------------------------------\n _Comment           | null                                                         \n _ContentLicense    | CC BY-SA 3.0                                                 \n _CreationDate      | 2014-01-21 20:26:05.383                                      \n _Id                | 1                                                            \n _PostHistoryTypeId | 2                                                            \n _PostId            | 1                                                            \n _RevisionGUID      | a17002a0-00b0-417b-a404-0d8864bbbca5                         \n _Text              | I was offered a beer the other day that was reportedly ma... \n _UserDisplayName   | null                                                         \n _UserId            | 7                                                            \nonly showing top 1 row\n\n```\n:::\n:::\n\n\n\\normalsize\n### Plik `Badges`\n\n\\small\n\n::: {.cell execution_count=18}\n``` {.python .cell-code}\nbadges_schema = StructType([\n    StructField(\"_Class\", IntegerType()),\n    StructField(\"_Date\", TimestampType()),\n    StructField(\"_Id\", IntegerType()),\n    StructField(\"_Name\", StringType()),\n    StructField(\"_TagBased\", BooleanType()),\n    StructField(\"_UserId\", IntegerType()),\n])\n```\n:::\n\n\n::: {.cell execution_count=19}\n\n::: {.cell-output .cell-output-stdout}\n```\n+------+----------------------+---+--------------+---------+-------+\n|_Class|_Date                 |_Id|_Name         |_TagBased|_UserId|\n+------+----------------------+---+--------------+---------+-------+\n|3     |2014-01-21 20:52:16.97|1  |Autobiographer|false    |1      |\n|3     |2014-01-21 20:52:16.97|2  |Autobiographer|false    |2      |\n|3     |2014-01-21 20:52:16.97|3  |Autobiographer|false    |6      |\n|3     |2014-01-21 20:52:16.97|4  |Autobiographer|false    |7      |\n|3     |2014-01-21 20:52:16.97|5  |Autobiographer|false    |9      |\n+------+----------------------+---+--------------+---------+-------+\nonly showing top 5 rows\n\n```\n:::\n:::\n\n\n\\normalsize\n## Czyszczenie kolumn tekstowych {#sec-text-cleanup}\n\nPliki `Users`, `History` oraz `Posts` zawierają koumny tekstowe z danymi wpisywanymi przez użytkowników oraz często zawierające znaki specjalne czy tagi html. W związku z tym kolumny `_AboutMe` (plik `Users`), `_Text` (plik `History`) oraz `_Body` (plik `Posts`) zostały poddane procesowi oczyszczania. \n\nW tym celu utworzono funkcję `UDF` o nazwie `tags_remove()` @sec-tags-remove, która odpowiada za usunięcie tagów html.\n\n\\small\n\n\n\\normalsize\nDodatkowo znaki `\\n`, `\\t`, `\\r` oraz podwójne spacje zastąpiono pojedynczymi znakami spacji a także usunięto znaki spacji z początków i końców wartości tekstowych.\n\n\nPoniżej zaprezentowano przykłady kolumn nieoczyszczonych oraz po ich oczyszczeniu (zawierające końcówkę `_clean`):\n  \n  - Dla pliku `Users`:\n\\small\n\n::: {.cell execution_count=22}\n\n::: {.cell-output .cell-output-stdout}\n```\n-RECORD 0----------------------------------------------------------------------\n _AboutMe       | <p>Hi, I'm not really a person.</p>\\n\\n<p>I'm a backgroun... \n _AboutMe_clean | Hi, I'm not really a person. I'm a background process tha... \n-RECORD 1----------------------------------------------------------------------\n _AboutMe       | <p>Dev #2 who helped create Stack Overflow currently work... \n _AboutMe_clean | Dev #2 who helped create Stack Overflow currently working... \n-RECORD 2----------------------------------------------------------------------\n _AboutMe       | <p>Former Stack Exchange employee</p>\\n                      \n _AboutMe_clean | Former Stack Exchange employee                               \n-RECORD 3----------------------------------------------------------------------\n _AboutMe       | \\n<p>Developer at Stack Overflow focusing on public Q&amp... \n _AboutMe_clean | Developer at Stack Overflow focusing on public Q&A. Russi... \n-RECORD 4----------------------------------------------------------------------\n _AboutMe       | <p><strong>BY DAY:</strong> I execute projects on both mo... \n _AboutMe_clean | BY DAY: I execute projects on both mobile and on the web ... \nonly showing top 5 rows\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\r[Stage 7:>                                                          (0 + 1) / 1]\r\r                                                                                \r\n```\n:::\n:::\n\n\n\\normalsize\n  - Dla pliku `History`:\n\\small\n\n::: {.cell execution_count=23}\n\n::: {.cell-output .cell-output-stdout}\n```\n-RECORD 0-------------------------------------------------------------------\n _Text       | I was offered a beer the other day that was reportedly ma... \n _Text_clean | I was offered a beer the other day that was reportedly ma... \n-RECORD 1-------------------------------------------------------------------\n _Text       | What is a citra hop, and how does it differ from other hops? \n _Text_clean | What is a citra hop, and how does it differ from other hops? \n-RECORD 2-------------------------------------------------------------------\n _Text       | <hops>                                                       \n _Text_clean |                                                              \n-RECORD 3-------------------------------------------------------------------\n _Text       | As far as we know, when did humans first brew beer, and w... \n _Text_clean | As far as we know, when did humans first brew beer, and w... \n-RECORD 4-------------------------------------------------------------------\n _Text       | When was the first beer ever brewed?                         \n _Text_clean | When was the first beer ever brewed?                         \nonly showing top 5 rows\n\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n/config/workspace/env/lib/python3.10/site-packages/bs4/__init__.py:435: MarkupResemblesLocatorWarning: The input looks more like a filename than markup. You may want to open this file and pass the filehandle into Beautiful Soup.\n  warnings.warn(\n```\n:::\n:::\n\n\n\\normalsize\n  - Dla pliku `Posts`:\n\\small\n\n::: {.cell execution_count=24}\n\n::: {.cell-output .cell-output-stdout}\n```\n-RECORD 0-------------------------------------------------------------------\n _Body       | <p>I was offered a beer the other day that was reportedly... \n _Body_clean | I was offered a beer the other day that was reportedly ma... \n-RECORD 1-------------------------------------------------------------------\n _Body       | <p>As far as we know, when did humans first brew beer, an... \n _Body_clean | As far as we know, when did humans first brew beer, and w... \n-RECORD 2-------------------------------------------------------------------\n _Body       | <p>How is low/no alcohol beer made? I'm assuming that the... \n _Body_clean | How is low/no alcohol beer made? I'm assuming that the be... \n-RECORD 3-------------------------------------------------------------------\n _Body       | <p>Citra is a registered trademark since 2007. Citra Bran... \n _Body_clean | Citra is a registered trademark since 2007. Citra Brand h... \n-RECORD 4-------------------------------------------------------------------\n _Body       | <p>In general, what's the best way to work out the temper... \n _Body_clean | In general, what's the best way to work out the temperatu... \nonly showing top 5 rows\n\n```\n:::\n:::\n\n\nTak przygotowane dane,  w celu optymalizacji miejsca zajmowanego w koszyku S3, oraz w celu przyspieszenia procesu wczytywania danych zapisano w formacie `parquet`. Zaskutkowało to redukcją zajmowanego miejsca w koszuku o około 50%.\n\\normalsize\n\\small\n\n\n\\normalsize\n\n",
    "supporting": [
      "01_preprocessing_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}